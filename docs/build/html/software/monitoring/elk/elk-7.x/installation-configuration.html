

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Installation and Configuration &mdash; apolo-docs 0.1 documentation</title>
      <link rel="stylesheet" href="../../../../_static/css/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/sidebar.css" type="text/css" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="ELK Stack 7.x" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

  
    <a href="../../../../index.html" class="icon icon-home"> apolo-docs
  

  
    </a>

    

    
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../gettingstarted/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../supercomputers/index.html">Supercomputers</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Software</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../virtualization/index.html">Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../programminglanguages/index.html">Programming Languages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../applications/index.html">Scientific Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../managementsoftware/index.html">Management Software</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../provisioning/index.html">Provisioning</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Monitoring</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../architecture/index.html">Monitoring Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../nagios/index.html">Nagios</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sensu/index.html">Sensu</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">ELK</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../elk-6.x/index.html">ELK Stack 6.x Installation and Configuration</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html">ELK Stack 7.x</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana/index.html">Grafana</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apolomonitoring/index.html">Apolo Monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sensu_go/index.html">Sensu Go</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../operatingsystems/index.html">Operating Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../scientific_libraries/index.html">Scientific Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../accelerators/index.html">Accelerators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../how-to-acknowledge.html">How to Acknowledge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../report-a-bug.html">Report a Bug</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">apolo-docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Software</a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Monitoring</a></li>
          <li class="breadcrumb-item"><a href="../index.html">ELK</a></li>
          <li class="breadcrumb-item"><a href="index.html">ELK Stack 7.x</a></li>
      <li class="breadcrumb-item active">Installation and Configuration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/software/monitoring/elk/elk-7.x/installation-configuration.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="installation-and-configuration">
<span id="installation-7-x-label"></span><span id="installation-configuration-index"></span><h1><a class="toc-backref" href="#id1" role="doc-backlink">Installation and Configuration</a><a class="headerlink" href="#installation-and-configuration" title="Link to this heading"></a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#installation-and-configuration" id="id1">Installation and Configuration</a></p>
<ul>
<li><p><a class="reference internal" href="#elasticsearch" id="id2">Elasticsearch</a></p></li>
<li><p><a class="reference internal" href="#logstash" id="id3">Logstash</a></p></li>
<li><p><a class="reference internal" href="#kibana" id="id4">Kibana</a></p>
<ul>
<li><p><a class="reference internal" href="#indexes-and-mappings" id="id5">Indexes and Mappings</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#filebeat" id="id6">Filebeat</a></p></li>
</ul>
</li>
</ul>
</nav>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>It is <strong>very important</strong> to make the cluster nodes visible between them by their DNS. Otherwise, the services might not properly start. If this happens, dig into the log files and find out the problem.</p></li>
<li><p>Correctly configure the date and time of the cluster. Otherwise, visualizing the logs in Kibana might be a problem. This due that the log timestamp will be on a different date of that of the Kibana server.</p></li>
<li><p>Install Java JDK 8, more recent versions may have compatibility problems.</p></li>
<li><p>Use the same version for Logstash, Elasticsearch, Kibana, and Filebeat to avoid compatibility problems.</p></li>
<li><p>Also, when reading the guides check that the guide version is compatible with the version of the ELK stack in use.</p></li>
<li><p>In case of having more than 500MB in logs, the RAM used by Logstash and Elasticsearch is something to consider. By default 1GB for heap, plus the jvm (which runs some other things), so more or less 2.0 - 3.0 GB of RAM. Therefore ensure at least 4-6GB of RAM (even more when having gigabytes of logs) in the server that Elasticsearch and Logstash will be installed.</p></li>
<li><p>If RAM is not a problem, and there is a need for more RAM on Elasticsearch or Logstash, increase the heap size by modifying the <code class="code highlight bash docutils literal highlight-bash">jvm.options</code> file, which is usually located under <code class="code highlight bash docutils literal highlight-bash">/etc/&lt;service&gt;</code> or under <code class="code highlight bash docutils literal highlight-bash">/usr/share/&lt;service&gt;/config</code>. Look for the options <code class="code highlight bash docutils literal highlight-bash">-Xms1g</code> and <code class="code highlight bash docutils literal highlight-bash">-Xmx1g</code> and change the <em>1g</em> to an the value needed. The chosen value should be the same in both options, for more information about the heap read <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html">here</a>.</p></li>
<li><p>Install, configure, and start the services in the following order, then repeating some steps will be avoided, as well as some problems. Note that this order is the same as the one in the Ansible role <code class="code highlight bash docutils literal highlight-bash">elk</code>.</p>
<ul>
<li><p>Elasticsearch: <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/index.htm">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/index.htm</a></p></li>
<li><p>Logstash: <a class="reference external" href="https://www.elastic.co/guide/en/logstash/7.1/index.html">https://www.elastic.co/guide/en/logstash/7.1/index.html</a></p></li>
<li><p>Kibana: <a class="reference external" href="https://www.elastic.co/guide/en/kibana/7.1/index.html">https://www.elastic.co/guide/en/kibana/7.1/index.html</a></p></li>
<li><p>Filebeat: <a class="reference external" href="https://www.elastic.co/guide/en/beats/filebeat/7.1/index.html">https://www.elastic.co/guide/en/beats/filebeat/7.1/index.html</a></p></li>
</ul>
</li>
<li><p>If any service fails or is working in an unexpected way check the logs. They are usually under <code class="code highlight bash docutils literal highlight-bash">/usr/share/&lt;service&gt;/logs</code> or under <code class="code highlight bash docutils literal highlight-bash">/var/log/&lt;service&gt;</code>.</p></li>
</ul>
</div>
<p>The architecture in which the ELK Stack was installed is the following.</p>
<img alt="../../../../_images/ELK.png" src="../../../../_images/ELK.png" />
<p>Although we are using this architecture, it may be modificated in any way, just pay close attention to the configuration files.
Also, it is important to note that the stack of applications was installed on CentOS 7 using <a class="reference external" href="https://www.ansible.com/">Ansible</a>. Therefore, in the next subsections, there will be an explanation of the Ansible roles used to install and configure each of the ELK Stack components. The directory structure of the Ansible project is described <a class="reference download internal" download="" href="../../../../_downloads/4e8a04dc7998980a6adce2924f5a5d6f/ansible_dir_structure.txt"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<ol class="arabic simple">
<li><p>Before proceeding to the installation of each main component, it is needed to add the ELK’s repository to the rpm’s repositories.</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># roles/elk/tasks/add-elk-repo.yml</span>

<span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Download public signing key</span>
<span class="w">  </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Add elk repository file</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;etc/yum.repos.d/elk.repo.j2&quot;</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/yum.repos.d/elk.repo&quot;</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0644</span>
</pre></div>
</div>
<p>This playbook basically adds the ELK’s gpg signing key to rpm and takes a template, <code class="code highlight bash docutils literal highlight-bash">roles/elk/templates/etc/yum.repos.d/elk.repo.j2</code>, to render it in the <code class="code highlight bash docutils literal highlight-bash">/etc/yum/repos.d/</code> directory, which is where <code class="code highlight bash docutils literal highlight-bash">rpm</code> looks for its repositories. The template file is this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># roles/elk/templates/etc/yum.repos.d/elk.repo.j2</span>

<span class="o">[</span>elastic-<span class="o">{{</span><span class="w"> </span>elk_version<span class="w"> </span><span class="o">}}]</span>
<span class="nv">name</span><span class="o">=</span>Elastic<span class="w"> </span>repository<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">{{</span><span class="w"> </span>elk_version<span class="w"> </span><span class="o">}}</span><span class="w"> </span>packages
<span class="nv">baseurl</span><span class="o">=</span>https://artifacts.elastic.co/packages/<span class="o">{{</span><span class="w"> </span>elk_version<span class="w"> </span><span class="o">}}</span>/yum
<span class="nv">gpgcheck</span><span class="o">=</span><span class="m">1</span>
<span class="nv">gpgkey</span><span class="o">=</span>https://artifacts.elastic.co/GPG-KEY-elasticsearch
<span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>
<span class="nv">autorefresh</span><span class="o">=</span><span class="m">1</span>
<span class="nv">type</span><span class="o">=</span>rpm-md
</pre></div>
</div>
<p>The <code class="code highlight yaml docutils literal highlight-yaml"><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">elk_version</span><span class="w"> </span><span class="p p-Indicator">}}</span></code> jinja variable refers to the version of the desired stack. In this case 7.x. This variable must be passed as an argument when running Ansible or have it defined somewhere in the Ansible project. For more information about variables go to the Ansible’s <a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html">documentation</a>.</p>
<ol class="arabic simple">
<li><p>Also, it is needed to install Java 8 and the main components (Elasticsearch, Logstash, Kibana) packages.</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># roles/elk/tasks/install-elk.yml</span>

<span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install Java</span>
<span class="w">  </span><span class="nt">yum</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">java-{{ java_version }}-openjdk-devel</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install logstash-elasticsearch-kibana</span>
<span class="w">  </span><span class="nt">yum</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logstash</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">elasticsearch</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kibana</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</pre></div>
</div>
<p>The variable <code class="code highlight yaml docutils literal highlight-yaml"><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">java_version</span><span class="w"> </span><span class="p p-Indicator">}}</span></code> represents the java version used, in this case (and to ensure <a class="reference external" href="https://www.elastic.co/support/matrix#matrix_jvm">compatibility</a>) 1.8.0.</p>
<section id="elasticsearch">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Elasticsearch</a><a class="headerlink" href="#elasticsearch" title="Link to this heading"></a></h2>
<p>After installing the needed package, Elasticsearch is configured like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># roles/elk/tasks/config.yml</span>

<span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure elasticsearch</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;etc/elasticsearch/elasticsearch.yml.j2&quot;</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/elasticsearch/elasticsearch.yml&quot;</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0644</span>
<span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable_restart_elasticsearch</span>
</pre></div>
</div>
<p>The Elasticsearch main configuration file, which is the template <code class="code highlight bash docutils literal highlight-bash">roles/elk/templates/etc/elasticsearch/elasticsearch.yml.j2</code>, is rendered in <code class="code highlight bash docutils literal highlight-bash">/etc/elasticsearch/</code>. The template can be found <a class="reference download internal" download="" href="../../../../_downloads/32f84f8ef847a6de08a8e084dc51c3a3/elasticsearch.yml.j2"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>. In that template, there is a variable called <code class="code highlight yaml docutils literal highlight-yaml"><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">machine</span><span class="w"> </span><span class="p p-Indicator">}}</span></code>, which is rendered as the hostname of the ELK server, in this case <code class="code highlight bash docutils literal highlight-bash">elk</code>. It can be changed as needed, but from now on in this guide, <code class="code highlight bash docutils literal highlight-bash">elk</code> is what will be used. Note that, when the configuration file is placed, a notify is made so that the Elasticsearch service is started/restarted. The notify handler looks like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># roles/elk/handlers/main.yml</span>

<span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable_restart_elasticsearch</span>
<span class="w">  </span><span class="nt">systemd</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">elasticsearch</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that the identifier given to the notify action in the configuration task must be same as the identifier given to the handler.</p>
</div>
</section>
<section id="logstash">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Logstash</a><a class="headerlink" href="#logstash" title="Link to this heading"></a></h2>
<p>After installing the needed package, Logstash is configured like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># roles/elk/tasks/config.yml</span>

<span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure logstash</span>
<span class="w">  </span><span class="nt">copy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;etc/logstash/{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/logstash/{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0644</span>
<span class="w">  </span><span class="nt">with_items</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pipelines.yml</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logstash.yml</span>
<span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable_restart_logstash</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Logstash main pipeline configuration file</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;etc/logstash/conf.d/main_pipeline.conf.j2&quot;</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/logstash/conf.d/main_pipeline.conf&quot;</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0644</span>
<span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable_restart_logstash</span>
</pre></div>
</div>
<p>The first task copies two configuration files, <code class="code highlight bash docutils literal highlight-bash">pipelines.yml</code>, and <code class="code highlight bash docutils literal highlight-bash">logstash.yml</code> to <code class="code highlight bash docutils literal highlight-bash">/etc/logstash</code>. The former indicates to Logstash where to find our pipelines configuration files. It can be found <a class="reference download internal" download="" href="../../../../_downloads/662d23c05a29fe5812b414f955c8e9d3/pipelines.yml"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>. The latter is the main configuration file for Logstash. It can be found <a class="reference download internal" download="" href="../../../../_downloads/2346b96fac1ec877cbeea48f7a4c9fdb/logstash.yml"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<p>The second task takes a template, <code class="code highlight bash docutils literal highlight-bash">roles/elk/templates/etc/logstash/conf.d/main_pipeline.conf.j2</code>, and renders it in the pipelines directory, <code class="code highlight bash docutils literal highlight-bash">/etc/logstash/conf.d</code>. The template represents the description of the main pipeline, that is, inputs, filters, and outputs. It can be found <a class="reference download internal" download="" href="../../../../_downloads/046fdac7275110b1e808c4987c9b0611/main_pipeline.conf.j2"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Logstash Filters:</strong> It is important to know the version of the filter plugins being used, so that the proper documentation can be found.</p>
</div>
</section>
<section id="kibana">
<span id="kibana-7-x-label"></span><h2><a class="toc-backref" href="#id4" role="doc-backlink">Kibana</a><a class="headerlink" href="#kibana" title="Link to this heading"></a></h2>
<p>After installing the needed package, Kibana is configured like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># roles/elk/tasks/config.yml</span>

<span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure kibana</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;etc/kibana/kibana.yml.j2&quot;</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/kibana/kibana.yml&quot;</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0644</span>
<span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable_restart_kibana</span>
</pre></div>
</div>
<p>The Kibana main configuration file, which is the template <code class="code highlight bash docutils literal highlight-bash">roles/elk/templates/etc/kibana/kibana.yml.j2</code>, is rendered in <code class="code highlight bash docutils literal highlight-bash">/etc/kibana/</code>. The template can be found <a class="reference download internal" download="" href="../../../../_downloads/c17f593239eaa1f4f28c438f21ee5ebc/kibana.yml.j2"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>. Also, when the configuration file is placed, a notify is made so that the Kibana service is started/restarted. The notify handler looks like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># roles/elk/handlers/main.yml</span>

<span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable_restart_kibana</span>
<span class="w">  </span><span class="nt">systemd</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kibana</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</pre></div>
</div>
<section id="indexes-and-mappings">
<span id="kibana-7-x-mappings-label"></span><h3><a class="toc-backref" href="#id5" role="doc-backlink">Indexes and Mappings</a><a class="headerlink" href="#indexes-and-mappings" title="Link to this heading"></a></h3>
<p>After installing and configuring Kibana, it is time to give structure to our logs and create/import the dashboards and visualizations needed:</p>
<ol class="arabic simple">
<li><p>Access the web interface through <em>http://elk:5601</em>. To access it using the domain name <code class="code highlight bash docutils literal highlight-bash">elk</code> remember to make the cluster nodes visible by their DNS’, in this case, the node where Kibana is installed.</p></li>
<li><p>Organize the information. This will help plotting all the data easily. To add a new logging source see the section below <a class="reference internal" href="adding-logging-source.html#new-source-7-x"><span class="std std-ref">Adding a new Logging Source</span></a>.</p></li>
</ol>
<blockquote>
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Create the indexes and the mappings BEFORE sending any data to Elasticsearch, otherwise, data would end up in unexpected indexes.</p>
</div>
<ol class="loweralpha">
<li><p>Create <em>indexes</em> and <em>mappings</em>, that is, give types and format to the data.</p>
<ul class="simple">
<li><p>In the <strong>Dev Tools</strong> section, copy and paste the contents of the index and mappings <a class="reference download internal" download="" href="../../../../_downloads/3a56c27fc1ed14c30a76abdc64e705ba/indexes_and_mappings.txt"><code class="xref download docutils literal notranslate"><span class="pre">file</span></code></a>, then select it all and click on RUN. These mappings can be used as a reference to create more mappings.</p></li>
<li><p>To easily see the mappings go to: <strong>Management</strong> -&gt; <strong>Index management</strong> -&gt; <strong>Click on the desired index</strong> -&gt; <strong>Mapping</strong>.</p></li>
</ul>
</li>
<li><p>Create the dashboard and visualizations.</p>
<ul>
<li><p>Go to the <strong>Management</strong> section, then, go to the subsection <strong>Saved Objects</strong>, then, <strong>Import</strong>, and import the dashboards and visualizations <a class="reference download internal" download="" href="../../../../_downloads/ee1e4e258169bb758c0bae97b684daf7/dashboards_and_visualizations.json"><code class="xref download docutils literal notranslate"><span class="pre">file</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To export the visualizations and dashborads to a json format, remember to check the <em>every saved object</em> option. Otherwise some visualizations may depend on other objects that might not be exported, ending up with errors when importing them again.</p>
</div>
</li>
</ul>
</li>
<li><p>In the section <strong>Management</strong> -&gt; <strong>Kibana</strong> -&gt; <strong>Index Patterns</strong> select one (no matter which one) index pattern and press the star button to make it the default one.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="filebeat">
<span id="filebeat-7-x-label"></span><h2><a class="toc-backref" href="#id6" role="doc-backlink">Filebeat</a><a class="headerlink" href="#filebeat" title="Link to this heading"></a></h2>
<p>Recall that in this case Filebeat is installed in nodes different from the ELK Server, the architecture used here is on <a class="reference internal" href="#installation-7-x-label"><span class="std std-ref">Installation and Configuration</span></a>.</p>
<p>So, the installation playbook looks like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># roles/master/tasks/config.yml</span>

<span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Download public signing key</span>
<span class="w">  </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Add elk repository file</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;etc/yum.repos.d/elk.repo.j2&quot;</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/yum.repos.d/elk.repo&quot;</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0644</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install filebeat</span>
<span class="w">  </span><span class="nt">yum</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">filebeat</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure filebeat</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">etc/filebeat/filebeat.yml.j2</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/filebeat/filebeat.yml</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rot</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0644</span>
<span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable_restart_filebeat</span>
</pre></div>
</div>
<p>As previously explained, the three first tasks are for adding the ELK’s repository and installing the main component package. The last task is for configuring Filebeat. It takes a template file that contains the Filebeat main configuration, basically, where it will take the logs from. The template file can be found <a class="reference download internal" download="" href="../../../../_downloads/6bf1fb311a02f5258244f7418deff26d/filebeat.yml.j2"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>. Then, after Filebeat is configured, a notify is sent to a handler to start/restart the Filebeat service. The handler looks like this:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that the folder under <code class="code highlight bash docutils literal highlight-bash">roles/</code> is not <code class="code highlight bash docutils literal highlight-bash">elk/</code> anymore. It is <code class="code highlight bash docutils literal highlight-bash">master/</code> because the idea is to install the log collector in the master nodes, which then, will start sending logs to the <code class="code highlight bash docutils literal highlight-bash">elk</code> server.</p>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># roles/master/handlers/main.yml</span>

<span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable_restart_filebeat</span>
<span class="w">  </span><span class="nt">service</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">filebeat</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</pre></div>
</div>
<p>Make sure that the paths to the logs given in <code class="code highlight bash docutils literal highlight-bash">filebeat.yml</code> are correct. Everythin is correct if data can be seen in Kibana. Go to the <strong>Discover</strong> section, select some index pattern and select a time window, something similar to 1 month ago, or change it as needed. This time window represents the time range that Kibana uses to query the logs to Elasticsearch. For example, if to analyze the last year logs, choose <strong>1 year ago -&gt; now</strong>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="ELK Stack 7.x" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="testing.html" class="btn btn-neutral float-right" title="Testing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Creative Commons Attribution-NonCommercial 4.0 International License.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>